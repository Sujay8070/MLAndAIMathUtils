
# Synthetic image generation and COCO annotations

Table of contents
=================

<!--ts-->
* [Summary](https://github.com/OmdenaAI/SkyMaps/tree/main/Task3-Annotation/SyntheticImages#summary)
* [Data augumentation pipe line](https://github.com/OmdenaAI/SkyMaps/tree/main/Task3-Annotation/SyntheticImages#data-augumentation-pipeline)
* [About COCO dataset and specification](https://github.com/OmdenaAI/SkyMaps/tree/main/Task3-Annotation/SyntheticImages#about-coco-dataset-and-specification)
* [Design idea](https://github.com/OmdenaAI/SkyMaps/tree/main/Task3-Annotation/SyntheticImages#design-idea)
* [Libraries and tools used](https://github.com/OmdenaAI/SkyMaps/tree/main/Task3-Annotation/SyntheticImages#libraries-and-tools-used)
* [Creating foreground images](https://github.com/OmdenaAI/SkyMaps/tree/main/Task3-Annotation/SyntheticImages#creating-foreground-images)
* [Folder structure](https://github.com/OmdenaAI/SkyMaps/tree/main/Task3-Annotation/SyntheticImages#folder-structure)
* [Overview of scripts](https://github.com/OmdenaAI/SkyMaps/tree/main/Task3-Annotation/SyntheticImages#overview-of-scripts)
* [Sample generated image and mask](https://github.com/OmdenaAI/SkyMaps/tree/main/Task3-Annotation/SyntheticImages#sample-generated-image-and-mask)
* [References](https://github.com/OmdenaAI/SkyMaps/tree/main/Task3-Annotation/SyntheticImages#references)
<!--te-->


## Summary

Deep learning is wonderful tool which is changing the world of innovation in particular image applications. Due to the unprecedented need for massive, annotated, image datasets, we have to explore various options in additional to manual image collection and annotation. Data is extremely expensive, either in time or in money to pay others for their time in annotating images. Here we develop a tool which generates synthetic image datasets and annotate generated images in COCO format. We design and code scripts that composes foreground images of objects over top of random image backgrounds. This project provides hands on experience on image processing.

## Data augumentation pipeline

![image](https://user-images.githubusercontent.com/10434795/120897826-b5cbaf80-c645-11eb-82a0-65f53e27446d.png)

## About COCO dataset and specification

COCO annotations are inspired by the Common Objects in Context (COCO) dataset.  COCO is a large-scale object detection, segmentation, and captioning dataset.It is one of the best image datasets available, so it is widely used in cutting edge image recognition artificial intelligence research. It is used in open source projects such as Facebook Research's Detectron, Matterport's Mask R-CNN, endernewton's Tensorflow Faster RCNN for object Detection, object segmentation and others.

## Design idea

Design idea is that we are going to do image composition by pasting foreground images(usually.png) which has transparent background, so we can paste them on top of the background image and it looks just like the object orginally on that background. While the original COCO and skymaps dataset was created by manually drawing polygons or
by using tools which requires human intervention.  Here we use idea of automatically creating polygons and bounding box annotation which are required as part of COCO specification if we have masked image along with original image. So while generating synthetic images we also generate corresponding image masks.

Mapping of images to corresponding image mask, along with objects present in that image with corresponding color codes, category, and super category information is shown in `image_mask_mapping.json` file. This file along with synthetic images and corresponding synthetic image masks are generated by running `synthetic_image_generator.py`. 

By having this intermediate step of file `image_mask_mapping.json` instead of converting directly to COCO annotation file is that we can use this intermediate file to generate annotations other than COCO annotations in future.

The `image_mask_mapping.json` file acts as input for generating annotations for synthetic images for script `conv_to_coco_json_utils.py`. Below are hight level steps for generating COCO annotations from image and corresponing mask image:  <br>
          1. Write code to automatically split up the image into individual masks <br>
          2. Write code to create polygons out of each individual mask <br>
          3. Convert the information to COCO JSON <br>
          
The first step is to create bit masks for each item of interest in the scene. Here it doesn't matter what color you use, as long as there is a distinct color for each object in the image. We also don't need to be consistent with what colors you use, but you will need to make a note of what colors you used for each category. 

`Important note #1`: Even if there were multiple same objects books in one image, they would need different colors, because overlapping books would be impossible to distinguish by the code we are going to write.

`Important note #2`: Make sure each pixel is a solid color. Some image applications will perform smoothing around the edges, so you'll get blended colors and this method won't work. 

## Libraries and tools used

Synthetic image generation tool is developed using python3.0 language using following libraries: <br>
         1. `tqdm`: tqdm is a progress bar library designed to be fast and extensible. <br>
         2. `numpy`: This is a library for the Python programming language, adding support for large, multi-dimensional arrays and matrices, along with a <br>
                   large collection of high-level mathematical functions to operate on these arrays <br>
         3. `skimage`: scikit-image is an open-source image processing library for the Python programming language. <br>
                      It includes algorithms for segmentation, geometric transformations, color space manipulation, analysis, filtering, morphology, feature detection, and more.<br>
                      It is designed to interoperate with the Python numerical and scientific libraries NumPy and SciPy.<br>
         4. `shapely` : Shapely is a BSD-licensed Python package for manipulation and analysis of planar geometric objects. <br>
                      It is not concerned with data formats or coordinate systems. It is based on the widely deployed GEOS (the engine of PostGIS) and JTS  
                      (https://pypi.org/project/Shapely/1.2/) <br>
         5.  `PIL`: The Python Imaging Library adds image processing capabilities to your Python interpreter. <br>
                  This library provides extensive file format support, an efficient internal representation, and fairly powerful image processing capabilities.<br>
                  The core image library is designed for fast access to data stored in a few basic pixel formats. (https://pypi.org/project/Pillow/) <br>
         6. `GIMP`: GIMP is a cross-platform image editor available for GNU/Linux, OS X, Windows and more operating systems. Used for cutting foreground images from images. <br>
                
## Creating foreground images

Take photos with foreground objects using camera or phone. `GIMP` tool is used to cut foreground objects from photos by using GIMP image editor.
Link https://www.immersivelimit.com/tutorials/cutting-out-image-foregrounds-with-gimp provides well written tutorial on how to to cut foregrond images uing GIMP tool.

## Folder structure

Folder structure for tool. Scripts are written relative to following structure.

Important point: Synthetic data scripts are designed and coded in generic way which can be reused for other projects as well such a way we don't hardcode classes in code.
The way supercategories and categories are identified is through folder names in "input" folder. It is important to give proper names to supercategory folders and category folders as names mentioned here are used in annotation generation file.
 

     root_dir
       |
       ---datasets
       |    |
       |    ---input
       |    |    |
       |    |    |
       |    |    --- synthetic_dataset
       |    |    |      |
       |    |    |     --- backgrounds
       |    |    |      |     |
       |    |    |      |     --- *.png or *.jpeg background images.
       |    |    |      |
       |    |    |      --- foregrounds
       |    |    |            |
       |    |    |            --- supercategory (for example weeds)
       |    |    |            |     |
       |    |    |            |     --- category (for example thistle)
       |    |    |            |           |
       |    |    |            |            --- *.png category images (for example thistle foreground images)
       |    |    |            |
       |    |    |            --- supercategory (for example crops)
       |    |    |                  |
       |    |    |                  --- category (for example beetroot)
       |    |    |                        |
       |    |    |                        --- *.png category images (for example beetroot foreground images)
       |    |
       |    ---output
       |    |    |
       |    |    |
       |    |    --- images
       |    |    |     |
       |    |    |     --- generated synthetic images
       |    |    |
       |    |    --- masks
       |    |    |     |
       |    |    |     --- corresponding image masks for generated synthetic images
       |    |    |
       |    |    |--- image_mask_mapping.json (generated image to image masking json file used for generting annotations)
       |    |    |
       |    |    |--- dataset_info.json
       |    |    |
       |    |    |--- image_coco_annotations.json (generated coco annotations file used for training with generated images)
       |
       ---python
       |   |
       |   ---synthetic_image_generator.py
       |   ---conv_to_coco_json_utils.py
       |   ---coco_json_parser.py
       |   --- *.py (other python model files like faster RCNN scripts)
       
Sample folder structure is shown below

![image](https://user-images.githubusercontent.com/10434795/120920383-14436d00-c6dc-11eb-9993-7b2011d059ce.png)

## Overview of scripts

`synthetic_image_generator.py`: Script takes input folder and output folder as input. Input folder is used to get foreground images and background images for generating synthetic images. Output folder is used to store generated synthetic images and image masks. Output folder is also used for storing generated json file `image_mask_mapping.json` which is used by `conv_to_coco_json_utils.py` for generating image annotations in COCO format. Sample command is shown below <br>

   `python ./python/synthetic_image_generator.py --input_dir ./datasets/weeds_synthetic_dataset/input/ --output_dir ./datasets/weeds_synthetic_dataset/output --count 20 --width 512 --height 512` 

Help for synthetic_image_generator script snapshot is shown below
![image](https://user-images.githubusercontent.com/10434795/120920560-093d0c80-c6dd-11eb-853b-46afdcffdfc0.png)

`conv_to_coco_json_utils.py` which provided utility functions to programmatically provide for generated images annotations in COCO format.  This script takes input files image to image mask mapping (image_mask_mapping.json) file  and data information file (`dataset_info.json`) which is generated by script `synthetic_image_generator.py` and produces output annotation file `image_coco_annotations.json` file which can be used to for training purposes with synthetic images we have generated.  Sample command is shown below

   `python ./python/conv_to_coco_json_utils.py -md ./datasets/weeds_synthetic_dataset/output/image_mask_mapping.json -di ./datasets/weeds_synthetic_dataset/output/dataset_info.json`
   
 Help for conv_to_coco_json_utils script snapshot is shown below
 ![image](https://user-images.githubusercontent.com/10434795/120920768-19a1b700-c6de-11eb-945e-2c8bd6d22911.png)

## Sample generated image and mask

![image](https://user-images.githubusercontent.com/10434795/120921378-07754800-c6e1-11eb-9d30-be34a1bd1046.png)
![image](https://user-images.githubusercontent.com/10434795/120921397-165bfa80-c6e1-11eb-9aff-b8f551f7a2fc.png)

   
## References

 https://www.immersivelimit.com/tutorials/create-coco-annotations-from-scratch <br>
 https://www.immersivelimit.com/tutorials/composing-images-with-python-for-synthetic-datasets <br>
 https://www.immersivelimit.com/tutorials/cutting-out-image-foregrounds-with-gimp <br>
